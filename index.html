<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CRM PREVENCIÓN</title>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Excel export (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#07070a;
      --card:#10111a;
      --card2:#0c0d13;
      --text:#ffffff;
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.55);
      --line:rgba(255,255,255,.10);
      --red:#ff2a2a;
      --red2:#b80000;
      --soft:rgba(255,255,255,.04);
      --ok:#2dd4bf;
      --warn:#fbbf24;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 12% 0%, rgba(255,42,42,.20), transparent 60%),
        radial-gradient(900px 500px at 88% 10%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(180deg, #050509 0%, #090914 100%);
    }

    header{
      position:sticky; top:0; z-index:20;
      background: linear-gradient(180deg, rgba(0,0,0,.92) 0%, rgba(0,0,0,.70) 100%);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:16px 18px 12px 18px; flex-wrap:wrap;
    }
    .brand{display:flex; gap:12px; align-items:center}
    .mark{
      width:14px;height:14px;border-radius:999px;
      background: linear-gradient(135deg, var(--red), rgba(255,255,255,.70));
      box-shadow: 0 0 22px rgba(255,42,42,.55);
    }
    h1{margin:0; font-size:18px; letter-spacing:.22em; text-transform:uppercase}
    .sub{margin:2px 0 0 0; color:var(--muted); font-size:12px}

    .controls{
      display:flex; gap:10px; align-items:end; flex-wrap:wrap; justify-content:flex-end;
    }
    label{font-size:12px; color:var(--muted); display:grid; gap:6px}
    input, select, textarea, button{font:inherit}
    input, select, textarea{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 12px;
      outline: none;
    }
    textarea{min-height:56px; resize:vertical}

    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{
      border-color: rgba(255,255,255,.25);
      background: rgba(255,255,255,.06);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(255,42,42,.28), rgba(255,255,255,.06));
      border-color: rgba(255,42,42,.45);
    }
    .btn.ghost{ background: rgba(255,255,255,.02); border-color: rgba(255,255,255,.10); }
    .btn.danger{
      background: rgba(255,42,42,.10);
      border-color: rgba(255,42,42,.35);
      color: #ffd1d1;
    }
    .btn.small{ padding: 7px 10px; border-radius: 11px; font-size: 12px; }
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      background: rgba(255,255,255,.02);
    }

    main{ padding: 14px 18px 18px 18px; display:grid; gap:14px; }
    .shell{ display:grid; grid-template-columns: 360px 1fr; gap:14px; align-items:start; }
    .card{
      background: rgba(16,17,26,.86);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 20px;
      padding: 14px;
      box-shadow: 0 22px 90px rgba(0,0,0,.50);
      overflow:hidden;
    }
    .cardTitle{
      display:flex; justify-content:space-between; align-items:baseline; gap:10px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .cardTitle h2{ margin:0; font-size: 13px; letter-spacing: .12em; text-transform: uppercase; }
    .hint{ color: var(--muted); font-size: 12px; }

    /* People list */
    .peopleList{ display:grid; gap:10px; margin-top: 10px; }
    .personTile{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      cursor: pointer;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
    }
    .personTile:hover{ border-color: rgba(255,255,255,.20); background: rgba(255,255,255,.04); transform: translateY(-1px); }
    .personTile.active{
      border-color: rgba(255,42,42,.50);
      box-shadow: 0 0 0 2px rgba(255,42,42,.16) inset;
    }
    .personTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .personName{
      font-weight: 800;
      letter-spacing: .06em;
      text-transform: uppercase;
      font-size: 12px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 240px;
    }
    .editBtn{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      border-radius: 10px;
      padding: 6px 8px;
      cursor:pointer;
    }
    .editBtn:hover{ border-color: rgba(255,255,255,.20); color: var(--text); }
    .personMeta{ display:flex; gap:8px; flex-wrap:wrap; color: var(--muted2); font-size: 12px; }
    .tag{
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }

    /* Detail panel */
    .detailHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .detailTitle{ display:flex; flex-direction:column; gap:4px; }
    .detailTitle .big{
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .detailTitle .small{ color: var(--muted); font-size: 12px; }
    .detailActions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

    /* Activities */
    .activityList{ display:grid; gap:10px; }
    .activityCard{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      padding: 12px;
      display:grid;
      gap:10px;
    }
    .row1{
      display:grid;
      grid-template-columns: 1fr 280px;
      gap: 10px;
      align-items:start;
    }
    .actTitle input{
      width: 100%;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
    }
    .rightBox{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      padding: 10px;
      display:grid;
      gap:10px;
    }
    .progressLine{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      color: var(--muted);
      font-size: 12px;
    }
    .slider{ width: 100%; accent-color: var(--red); }

    .row2{
      display:grid;
      grid-template-columns: 240px 1fr;
      gap: 10px;
      align-items:start;
    }
    .notesBox textarea{
      width: 100%;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
    }
    .actFooter{
      display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap;
      color: var(--muted2);
      font-size: 12px;
    }

    /* Dates */
    .dateGrid{
      display:grid;
      gap:10px;
    }
    .dateRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:end;
    }
    .countdown{
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      font-size: 12px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .countdown b{ color: #fff; letter-spacing:.04em; }
    .countdown.ok b{ color: rgba(255,255,255,.95); }
    .countdown.soon b{ color: #fff; text-shadow:0 0 12px rgba(251,191,36,.22); }
    .countdown.late b{ color: #fff; text-shadow:0 0 14px rgba(255,42,42,.35); }
    .countdown .chip{
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .countdown .chip.late{ border-color: rgba(255,42,42,.45); }
    .countdown .chip.soon{ border-color: rgba(251,191,36,.35); }
    .countdown .chip.ok{ border-color: rgba(255,255,255,.18); }

    /* Summary overlay */
    .summaryOverlay{
      display:none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(8px);
      z-index: 50;
      padding: 18px;
    }
    .summaryOverlay.show{ display:block; }
    .summaryInner{
      max-width: 1200px;
      margin: 0 auto;
      height: calc(100vh - 36px);
      display:grid;
      grid-template-rows: auto 1fr;
      gap: 12px;
    }
    .summaryHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      padding: 14px;
      border-radius: 20px;
      background: rgba(16,17,26,.92);
      border: 1px solid rgba(255,255,255,.12);
    }
    .summaryHead .title{
      font-weight: 900;
      letter-spacing: .12em;
      text-transform: uppercase;
      font-size: 14px;
    }
    .summaryBody{
      border-radius: 20px;
      background: rgba(16,17,26,.92);
      border: 1px solid rgba(255,255,255,.12);
      overflow:auto;
      padding: 14px;
    }

    /* Weekly stats block */
    .weeklyGrid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
      align-items:start;
    }
    .box{
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      padding: 12px;
    }
    .barWrap{
      border-radius: 18px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.08);
      padding: 10px;
    }
    table{ width: 100%; border-collapse: collapse; min-width: 920px; }
    th, td{ border-bottom: 1px solid rgba(255,255,255,.10); padding: 10px; vertical-align: top; }
    th{
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 12px;
      background: rgba(255,255,255,.02);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .cyl{
      height: 14px;
      width: 220px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      box-shadow: inset 0 2px 6px rgba(0,0,0,.40);
    }
    .cyl > div{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,42,42,.95), rgba(184,0,0,.95));
      box-shadow: inset 0 2px 10px rgba(255,255,255,.18);
    }
    .nowrap{ white-space:nowrap; }

    /* Priority chips */
    .prioSel{
      width: 100%;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px;
    }
    .prioChip{
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      font-size: 12px;
    }
    .prioChip.urgente{ border-color: rgba(255,42,42,.55); color:#fff; }
    .prioChip.alto{ border-color: rgba(255,42,42,.35); color:#fff; }
    .prioChip.medio{ border-color: rgba(255,255,255,.20); }
    .prioChip.normal{ border-color: rgba(255,255,255,.10); }

    /* Dialog */
    dialog{
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      background: rgba(10,10,14,.96);
      color: var(--text);
      padding: 0;
      max-width: 740px;
      width: calc(100% - 24px);
      box-shadow: 0 30px 140px rgba(0,0,0,.65);
    }
    .dlgForm{ padding: 14px; display:grid; gap:10px; }
    .dlgActions{ display:flex; gap:10px; justify-content:flex-end; padding-top:4px; }
    .two{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .teamList{
      display:grid; gap:8px;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      max-height: 280px;
      overflow:auto;
    }
    .teamRow{
      display:grid;
      grid-template-columns: 1fr 90px;
      gap:10px;
      align-items:center;
    }

    footer{
      padding: 12px 18px 18px 18px;
      color: rgba(255,255,255,.65);
      font-size: 12px;
      text-align:center;
      letter-spacing: .06em;
    }
    footer b{ color: rgba(255,255,255,.90); }

    @media (max-width: 1050px){
      .shell{ grid-template-columns: 1fr; }
      .weeklyGrid{ grid-template-columns: 1fr; }
      .row1{ grid-template-columns: 1fr; }
      .row2{ grid-template-columns: 1fr; }
      .dateRow{ grid-template-columns: 1fr; }
      table{ min-width: 0; }
      .cyl{ width: 180px; }
    }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="mark"></div>
      <div>
        <h1>CRM PREVENCIÓN</h1>
        <div class="sub">Actividades + fechas opcionales con cuenta atrás (edición con código 0800)</div>
      </div>
    </div>

    <div class="controls">
      <label>
        Semana que inicia (lunes)
        <input id="weekPicker" type="date">
      </label>
      <button class="btn ghost" id="btnResumen">Resumen</button>
      <button class="btn ghost" id="btnTeam">Editar equipo</button>
      <button class="btn primary" id="btnAddAct">+ Nueva actividad</button>
      <button class="btn" id="btnExportExcel">Exportar Excel</button>
      <span class="pill">Guardado automático (este navegador)</span>
    </div>
  </div>
</header>

<main>
  <div class="shell">
    <!-- LEFT: PEOPLE -->
    <section class="card">
      <div class="cardTitle">
        <h2>Equipo</h2>
        <div class="hint">Click en un nombre para ver solo sus actividades.</div>
      </div>

      <input id="peopleSearch" type="text" placeholder="Buscar persona..." />

      <div class="peopleList" id="peopleList"></div>
    </section>

    <!-- RIGHT: DETAIL -->
    <section class="card" id="detailCard">
      <div class="detailHead">
        <div class="detailTitle">
          <div class="big" id="selPersonName">Selecciona una persona</div>
          <div class="small" id="selPersonMeta">Semana: —</div>
        </div>

        <div class="detailActions">
          <button class="btn" id="btnPrevWeek">◀ Semana</button>
          <button class="btn" id="btnNextWeek">Semana ▶</button>
          <button class="btn danger" id="btnClearPersonWeek" title="Borra actividades de ESTA semana solo para esta persona">Borrar semana (persona)</button>
        </div>
      </div>

      <div class="activityList" id="activityList"></div>

      <!-- Resumen embebido (solo aparece si no hay persona seleccionada o modo resumen) -->
      <div id="embeddedSummary" style="display:none; margin-top:12px"></div>
    </section>
  </div>
</main>

<footer>
  CREADO BY <b>Humber codes</b> — derechos reservados
</footer>

<!-- OVERLAY: RESUMEN GRANDE -->
<div class="summaryOverlay" id="summaryOverlay" aria-hidden="true">
  <div class="summaryInner">
    <div class="summaryHead">
      <div>
        <div class="title">Resumen semanal</div>
        <div class="hint" id="summaryWeekText">Semana: —</div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
        <button class="btn" id="btnCloseResumen">Cerrar</button>
      </div>
    </div>
    <div class="summaryBody" id="summaryBody"></div>
  </div>
</div>

<!-- DIALOG: NEW ACTIVITY -->
<dialog id="dlgAct">
  <form method="dialog" class="dlgForm">
    <h3 style="margin:0; letter-spacing:.12em; text-transform:uppercase">Nueva actividad</h3>

    <div class="two">
      <label>Persona
        <select id="newOwner"></select>
      </label>
      <label>Semana (lunes)
        <input id="newWeek" type="date" required>
      </label>
    </div>

    <label>Actividad
      <input id="newTitle" maxlength="200" placeholder="Ej: Inspección, informe, seguimiento..." required />
    </label>

    <div class="two">
      <label>% Avance
        <input id="newProgress" type="number" min="0" max="100" value="0" />
      </label>
      <label>Prioridad
        <select id="newPriority">
          <option value="normal">Normal</option>
          <option value="medio">Medio</option>
          <option value="alto">Alto</option>
          <option value="urgente">Urgente</option>
        </select>
      </label>
    </div>

    <div class="rightBox">
      <div class="progressLine">
        <span>Fechas (opcional)</span>
        <button class="btn small ghost" id="btnEnableNewDates" type="button">Editar fechas (código)</button>
      </div>
      <div class="two" id="newDatesBox" style="display:none;">
        <label>Fecha de ingreso
          <input id="newStartDate" type="date" />
        </label>
        <label>Fecha límite
          <input id="newDueDate" type="date" />
        </label>
      </div>
      <div class="hint">Para agregar/editar/borrar fechas se solicita código <b>0800</b>.</div>
    </div>

    <label>Notas
      <textarea id="newNotes" maxlength="500" placeholder="Opcional"></textarea>
    </label>

    <div class="dlgActions">
      <button class="btn">Cancelar</button>
      <button id="btnCreateAct" class="btn primary" value="ok">Crear</button>
    </div>
  </form>
</dialog>

<!-- DIALOG: EDIT TEAM -->
<dialog id="dlgTeam">
  <form method="dialog" class="dlgForm">
    <h3 style="margin:0; letter-spacing:.12em; text-transform:uppercase">Editar equipo</h3>

    <div class="hint">
      Cambia nombres, agrega o elimina personas. (Si eliminas una persona, se borran sus actividades).
    </div>

    <div class="teamList" id="teamList"></div>

    <div class="two">
      <label>Nueva persona
        <input id="addPersonName" maxlength="40" placeholder="Ej: Juan Pérez" />
      </label>
      <div style="display:grid; align-content:end">
        <button class="btn primary" id="btnAddPerson" type="button">+ Agregar</button>
      </div>
    </div>

    <div class="dlgActions">
      <button class="btn">Cerrar</button>
      <button class="btn ghost" id="btnSaveTeam" value="ok">Guardar</button>
    </div>
  </form>
</dialog>

<script>
/* =========================
   SECURITY NOTE:
   This "0800" code check is client-side (front-end).
   It blocks casual edits, but is NOT strong security.
========================= */

/* =========================
   CONFIG
========================= */
const EDIT_CODE = "0800";

/* =========================
   STORAGE KEYS
========================= */
const LS_KEY_DATA = "crm_prevencion_data_v5";
const LS_KEY_TEAM = "crm_prevencion_team_v5";

/* =========================
   HELPERS
========================= */
const $ = (id) => document.getElementById(id);

function clampInt(n, min, max, fallback=min){
  const x = parseInt(n, 10);
  if (Number.isNaN(x)) return fallback;
  return Math.max(min, Math.min(max, x));
}
function mondayOf(date=new Date()){
  const d = new Date(date);
  const day = d.getDay(); // 0 domingo
  const diff = (day === 0 ? -6 : 1) - day;
  d.setDate(d.getDate() + diff);
  d.setHours(0,0,0,0);
  return d.toISOString().slice(0,10);
}
function addDays(isoDate, days){
  const d = new Date(isoDate + "T00:00:00");
  d.setDate(d.getDate() + days);
  return d.toISOString().slice(0,10);
}
function uid(){
  return Math.random().toString(36).slice(2,9) + "-" + Date.now().toString(36);
}
function nowLocalISO(){
  const d = new Date();
  const pad = (n) => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function safeDateISO(v){
  // accept "" or YYYY-MM-DD
  if(!v) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  return "";
}
function promptCode(){
  const c = prompt("Ingrese código para editar fechas:", "");
  return (c || "").trim() === EDIT_CODE;
}
function toMs(iso){
  // iso date only; interpret as end-of-day for due date; start-of-day for start
  if(!iso) return null;
  return new Date(iso + "T00:00:00").getTime();
}
function humanCountdown(dueISO){
  const now = Date.now();
  const due = new Date(dueISO + "T23:59:59").getTime();
  const diff = due - now;

  const abs = Math.abs(diff);
  const days = Math.floor(abs / (1000*60*60*24));
  const hours = Math.floor((abs % (1000*60*60*24)) / (1000*60*60));
  const mins = Math.floor((abs % (1000*60*60)) / (1000*60));

  const txt = `${days}d ${hours}h ${mins}m`;
  return { diff, txt };
}

/* =========================
   PRIORITY
========================= */
const PRIORITY_ORDER = { normal:1, medio:2, alto:3, urgente:4 };
function prioLabel(p){ return (p||"normal"); }
function prioChipClass(p){ return (p||"normal"); }

/* =========================
   LOAD/SAVE
========================= */
function saveData(){ localStorage.setItem(LS_KEY_DATA, JSON.stringify(data)); }
function loadData(){
  try{ const raw = localStorage.getItem(LS_KEY_DATA); return raw ? JSON.parse(raw) : null; }
  catch(e){ return null; }
}
function saveTeam(){ localStorage.setItem(LS_KEY_TEAM, JSON.stringify(TEAM)); }
function loadTeam(){
  try{ const raw = localStorage.getItem(LS_KEY_TEAM); return raw ? JSON.parse(raw) : null; }
  catch(e){ return null; }
}

/* =========================
   STATE
========================= */
let TEAM = loadTeam() || ["Persona 1","Persona 2","Persona 3","Persona 4","Persona 5","Persona 6","Persona 7"];
let data = loadData() || { activities: [] };
let selectedPerson = TEAM[0] || "";
let viewMode = "person"; // "person" | "summary"

/* =========================
   GET WEEK & FILTERS
========================= */
function getWeek(){ return $("weekPicker").value; }
function weekActivities(week){ return data.activities.filter(a => a.week_start === week); }
function personWeekActivities(person, week){
  return data.activities.filter(a => a.owner === person && a.week_start === week);
}
function sortPersonRows(rows){
  return rows.slice().sort((a,b)=>{
    const pa = PRIORITY_ORDER[a.priority || "normal"] || 1;
    const pb = PRIORITY_ORDER[b.priority || "normal"] || 1;
    if(pb !== pa) return pb - pa;
    return String(b.id).localeCompare(String(a.id));
  });
}

/* =========================
   AUTO CARRY OVER INCOMPLETE TASKS
========================= */
function carryOverIncomplete(prevWeek, newWeek){
  if(!prevWeek || !newWeek || prevWeek === newWeek) return;

  const prev = data.activities.filter(a => a.week_start === prevWeek && clampInt(a.progress,0,100,0) < 100);
  if(!prev.length) return;

  const existing = new Set(
    data.activities
      .filter(a => a.week_start === newWeek && a.carried_from_id)
      .map(a => a.carried_from_id)
  );

  let created = 0;
  for(const a of prev){
    if(existing.has(a.id)) continue;

    data.activities.push({
      id: uid(),
      owner: a.owner,
      title: a.title,
      week_start: newWeek,
      progress: clampInt(a.progress,0,100,0),
      priority: a.priority || "normal",
      notes: a.notes || "",
      start_date: a.start_date || "",   // carry dates too
      due_date: a.due_date || "",
      carried_from_id: a.id,
      carried_from_week: prevWeek
    });
    created++;
  }
  if(created) saveData();
}

/* =========================
   RENDER: PEOPLE LIST
========================= */
function renderPeople(){
  const q = ($("peopleSearch").value || "").trim().toLowerCase();
  const list = $("peopleList");
  list.innerHTML = "";

  const week = getWeek();

  for(const person of TEAM){
    if(q && !person.toLowerCase().includes(q)) continue;

    const rows = personWeekActivities(person, week);
    const tasks = rows.length;
    const avg = tasks ? Math.round(rows.reduce((s,a)=>s+clampInt(a.progress,0,100,0),0)/tasks) : 0;
    const remaining = tasks ? rows.reduce((s,a)=>s+(100-clampInt(a.progress,0,100,0)),0) : 0;

    const tile = document.createElement("div");
    tile.className = "personTile" + (person === selectedPerson && viewMode === "person" ? " active" : "");
    tile.addEventListener("click", () => {
      selectedPerson = person;
      viewMode = "person";
      renderAll();
    });

    const top = document.createElement("div");
    top.className = "personTop";

    const name = document.createElement("div");
    name.className = "personName";
    name.textContent = person;

    const edit = document.createElement("button");
    edit.className = "editBtn";
    edit.type = "button";
    edit.textContent = "✎";
    edit.title = "Editar nombre";
    edit.addEventListener("click", (ev) => {
      ev.stopPropagation();
      openTeamDialog(person);
    });

    top.appendChild(name);
    top.appendChild(edit);

    const meta = document.createElement("div");
    meta.className = "personMeta";
    meta.innerHTML = `
      <span class="tag">${tasks} act.</span>
      <span class="tag">avg ${avg}%</span>
      <span class="tag">carga ${remaining}</span>
    `;

    tile.appendChild(top);
    tile.appendChild(meta);
    list.appendChild(tile);
  }
}

/* =========================
   DATE UI BUILD (per activity)
========================= */
function buildDateSection(activity){
  const box = document.createElement("div");
  box.className = "rightBox dateGrid";

  const head = document.createElement("div");
  head.className = "progressLine";
  head.innerHTML = `<span>Fechas y contador</span>`;

  const btnEdit = document.createElement("button");
  btnEdit.type = "button";
  btnEdit.className = "btn small ghost";
  btnEdit.textContent = "Editar/Borrar fechas (código)";
  head.appendChild(btnEdit);

  const inner = document.createElement("div");
  inner.style.display = "grid";
  inner.style.gap = "10px";

  const datesExist = !!(activity.start_date || activity.due_date);

  const dateInputs = document.createElement("div");
  dateInputs.className = "dateRow";
  dateInputs.style.display = "none"; // locked by default

  const startLabel = document.createElement("label");
  startLabel.textContent = "Fecha de ingreso";
  const start = document.createElement("input");
  start.type = "date";
  start.value = activity.start_date || "";
  startLabel.appendChild(start);

  const dueLabel = document.createElement("label");
  dueLabel.textContent = "Fecha límite";
  const due = document.createElement("input");
  due.type = "date";
  due.value = activity.due_date || "";
  dueLabel.appendChild(due);

  dateInputs.appendChild(startLabel);
  dateInputs.appendChild(dueLabel);

  const cd = document.createElement("div");
  cd.className = "countdown";
  cd.id = `cd-${activity.id}`;

  function updateCountdown(){
    const dueISO = activity.due_date || "";
    if(!dueISO){
      cd.className = "countdown";
      cd.innerHTML = `<span class="chip ok">SIN FECHA LÍMITE</span><b>—</b>`;
      return;
    }
    const { diff, txt } = humanCountdown(dueISO);
    const daysLeft = Math.floor(Math.abs(diff) / (1000*60*60*24));
    let status = "ok";
    if(diff < 0) status = "late";
    else if(daysLeft <= 2) status = "soon";

    cd.className = `countdown ${status}`;
    const chipClass = status === "late" ? "late" : (status === "soon" ? "soon" : "ok");
    const chipText = status === "late" ? "ATRASADO" : (status === "soon" ? "PRÓXIMO" : "EN TIEMPO");
    cd.innerHTML = `<span class="chip ${chipClass}">${chipText}</span><b>${status === "late" ? "-" : ""}${txt}</b>`;
  }

  updateCountdown();

  // Edit action (requires code)
  btnEdit.addEventListener("click", () => {
    if(!promptCode()){
      alert("Código incorrecto.");
      return;
    }
    // unlock
    dateInputs.style.display = "grid";

    // Save on change
    const saveNow = () => {
      activity.start_date = safeDateISO(start.value);
      activity.due_date = safeDateISO(due.value);

      // If both empty, treat as removed
      if(!activity.start_date && !activity.due_date){
        // nothing extra needed
      }

      saveData();
      updateCountdown();
      renderWeeklyStatsInto(); // refresh table
    };

    start.addEventListener("change", saveNow, { once:false });
    due.addEventListener("change", saveNow, { once:false });

    // Add a clear button (only when unlocked)
    if(!inner.querySelector("[data-clear='1']")){
      const clearBtn = document.createElement("button");
      clearBtn.type = "button";
      clearBtn.className = "btn small danger";
      clearBtn.textContent = "Borrar fechas";
      clearBtn.dataset.clear = "1";
      clearBtn.addEventListener("click", () => {
        if(!promptCode()){
          alert("Código incorrecto.");
          return;
        }
        start.value = "";
        due.value = "";
        activity.start_date = "";
        activity.due_date = "";
        saveData();
        updateCountdown();
        renderWeeklyStatsInto();
        dateInputs.style.display = "none";
      });
      inner.appendChild(clearBtn);
    }
  });

  inner.appendChild(dateInputs);
  inner.appendChild(cd);
  box.appendChild(head);
  box.appendChild(inner);

  return box;
}

/* =========================
   RENDER: PERSON DETAIL
========================= */
function renderSelectedDetail(){
  const week = getWeek();

  const embedded = $("embeddedSummary");
  const list = $("activityList");

  if(viewMode === "summary" || !selectedPerson){
    $("selPersonName").textContent = "Resumen (Responsable)";
    $("selPersonMeta").textContent = `Semana: ${week}`;
    list.innerHTML = "";
    embedded.style.display = "block";
    embedded.innerHTML = "";
    embedded.appendChild(buildWeeklyStatsBlock(true));
    return;
  }

  embedded.style.display = "none";
  embedded.innerHTML = "";

  $("selPersonName").textContent = selectedPerson;
  $("selPersonMeta").textContent = `Semana: ${week}`;

  list.innerHTML = "";

  const rows = sortPersonRows(personWeekActivities(selectedPerson, week));

  if(!rows.length){
    list.innerHTML = `<span class="pill">Sin actividades para ${selectedPerson} en esta semana. Usa “+ Nueva actividad”.</span>`;
    return;
  }

  for(const a of rows){
    const card = document.createElement("div");
    card.className = "activityCard";

    const row1 = document.createElement("div");
    row1.className = "row1";

    // Left: title
    const left = document.createElement("div");
    left.className = "actTitle";
    const title = document.createElement("input");
    title.type = "text";
    title.maxLength = 200;
    title.value = a.title;
    title.addEventListener("change", () => {
      a.title = title.value.trim().slice(0,200);
      saveData();
      renderWeeklyStatsInto();
    });
    left.appendChild(title);

    // Right: progress
    const right = document.createElement("div");
    right.className = "rightBox";

    const v = clampInt(a.progress,0,100,0);

    const progLine = document.createElement("div");
    progLine.className = "progressLine";
    progLine.innerHTML = `<span>% Avance</span><b>${v}%</b>`;

    const slider = document.createElement("input");
    slider.className = "slider";
    slider.type = "range";
    slider.min = 0;
    slider.max = 100;
    slider.value = v;

    const carga = document.createElement("div");
    carga.className = "progressLine";
    carga.innerHTML = `<span>Carga de proceso</span><b>${100 - v}</b>`;

    slider.addEventListener("input", () => {
      const nv = clampInt(slider.value,0,100,0);
      progLine.innerHTML = `<span>% Avance</span><b>${nv}%</b>`;
      carga.innerHTML = `<span>Carga de proceso</span><b>${100 - nv}</b>`;
    });
    slider.addEventListener("change", () => {
      a.progress = clampInt(slider.value,0,100,0);
      saveData();
      renderPeople();
      renderWeeklyStatsInto();
    });

    right.appendChild(progLine);
    right.appendChild(slider);
    right.appendChild(carga);

    row1.appendChild(left);
    row1.appendChild(right);

    // Row2: priority + notes
    const row2 = document.createElement("div");
    row2.className = "row2";

    const priBox = document.createElement("div");
    priBox.className = "rightBox";

    const priTop = document.createElement("div");
    priTop.className = "progressLine";
    priTop.innerHTML = `<span>Prioridad</span><span class="prioChip ${prioChipClass(a.priority)}">${prioLabel(a.priority).toUpperCase()}</span>`;

    const priSel = document.createElement("select");
    priSel.className = "prioSel";
    priSel.innerHTML = `
      <option value="normal">Normal</option>
      <option value="medio">Medio</option>
      <option value="alto">Alto</option>
      <option value="urgente">Urgente</option>
    `;
    priSel.value = a.priority || "normal";
    priSel.addEventListener("change", () => {
      a.priority = priSel.value;
      saveData();
      renderSelectedDetail();
      renderWeeklyStatsInto();
    });

    priBox.appendChild(priTop);
    priBox.appendChild(priSel);

    const notes = document.createElement("div");
    notes.className = "notesBox";
    const ta = document.createElement("textarea");
    ta.maxLength = 500;
    ta.placeholder = "Notas (opcional)";
    ta.value = a.notes || "";
    ta.addEventListener("change", () => {
      a.notes = ta.value.slice(0,500);
      saveData();
    });
    notes.appendChild(ta);

    row2.appendChild(priBox);
    row2.appendChild(notes);

    // Dates section (optional) with code gate
    const dateSection = buildDateSection(a);

    // Footer actions
    const foot = document.createElement("div");
    foot.className = "actFooter";

    const carried = a.carried_from_week ? ` • arrastre: ${a.carried_from_week}` : "";
    foot.innerHTML = `<span>ID: ${a.id}${carried}</span><span>carga: <b>${100 - clampInt(a.progress,0,100,0)}</b></span>`;

    const del = document.createElement("button");
    del.className = "btn danger";
    del.type = "button";
    del.textContent = "Borrar";
    del.addEventListener("click", () => {
      if(!confirm("¿Borrar esta actividad?")) return;
      data.activities = data.activities.filter(x => x.id !== a.id);
      saveData();
      renderAll();
    });

    foot.appendChild(del);

    card.appendChild(row1);
    card.appendChild(row2);
    card.appendChild(dateSection);
    card.appendChild(foot);
    list.appendChild(card);
  }
}

/* =========================
   BUILD WEEKLY STATS BLOCK (reusable)
========================= */
function buildWeeklyStatsBlock(isBig){
  const wrap = document.createElement("div");
  wrap.className = "weeklyGrid";

  const left = document.createElement("div");
  left.className = "box";
  left.innerHTML = `
    <div class="hint" style="margin-bottom:10px">
      Barras por persona (promedio de avance en la semana).
    </div>
    <div class="barWrap">
      <canvas id="${isBig ? "weekBarBig" : "weekBar"}" height="260"></canvas>
    </div>
  `;

  const right = document.createElement("div");
  right.className = "box";
  right.style.overflow = "auto";
  right.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Persona</th>
          <th>Actividad</th>
          <th class="nowrap">% Avance</th>
          <th class="nowrap">Carga</th>
          <th>Progreso</th>
          <th class="nowrap">Prioridad</th>
          <th class="nowrap">Límite</th>
          <th class="nowrap">Cuenta atrás</th>
        </tr>
      </thead>
      <tbody id="${isBig ? "weekTableBodyBig" : "weekTableBody"}"></tbody>
    </table>
  `;

  wrap.appendChild(left);
  wrap.appendChild(right);

  setTimeout(() => renderWeeklyStatsInto(isBig), 0);
  return wrap;
}

/* =========================
   WEEKLY STATS RENDER
========================= */
function renderWeeklyStatsInto(big=false){
  const week = getWeek();
  const rows = weekActivities(week);

  const tbId = big ? "weekTableBodyBig" : "weekTableBody";
  const barId = big ? "weekBarBig" : "weekBar";

  const tb = document.getElementById(tbId);
  const canvas = document.getElementById(barId);
  if(!tb || !canvas) return;

  tb.innerHTML = "";

  const sorted = rows.slice().sort((a,b)=>{
    if(a.owner !== b.owner) return a.owner.localeCompare(b.owner);
    const pa = PRIORITY_ORDER[a.priority || "normal"] || 1;
    const pb = PRIORITY_ORDER[b.priority || "normal"] || 1;
    if(pb !== pa) return pb - pa;
    return (clampInt(b.progress,0,100,0) - clampInt(a.progress,0,100,0));
  });

  if(!sorted.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="8"><span class="pill">No hay actividades en esta semana.</span></td>`;
    tb.appendChild(tr);
  }else{
    for(const a of sorted){
      const av = clampInt(a.progress,0,100,0);
      const carga = 100 - av;

      let limite = a.due_date || "";
      let ca = "—";
      if(limite){
        const { diff, txt } = humanCountdown(limite);
        ca = (diff < 0 ? "-" : "") + txt;
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="nowrap">${a.owner}</td>
        <td>${(a.title||"").slice(0,140)}</td>
        <td class="nowrap"><b>${av}%</b></td>
        <td class="nowrap">${carga}</td>
        <td><div class="cyl"><div style="width:${av}%"></div></div></td>
        <td class="nowrap"><span class="prioChip ${prioChipClass(a.priority)}">${prioLabel(a.priority).toUpperCase()}</span></td>
        <td class="nowrap">${limite || "—"}</td>
        <td class="nowrap">${ca}</td>
      `;
      tb.appendChild(tr);
    }
  }

  // Bar chart (avg progress by person)
  const labels = TEAM.slice();
  const avgs = labels.map(p => {
    const pr = personWeekActivities(p, week);
    if(!pr.length) return 0;
    return Math.round(pr.reduce((s,a)=>s+clampInt(a.progress,0,100,0),0)/pr.length);
  });

  window.__charts__ = window.__charts__ || {};
  if(window.__charts__[barId]){ try{ window.__charts__[barId].destroy(); }catch(e){} }

  window.__charts__[barId] = new Chart(canvas, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Avance promedio (%)",
        data: avgs,
        backgroundColor: "rgba(255,42,42,.80)",
        borderColor: "rgba(255,255,255,.18)",
        borderWidth: 1,
        borderRadius: 999,
        barThickness: 18
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => ` ${c.raw}%` } } },
      scales: {
        x: { ticks: { color: "rgba(255,255,255,.80)" }, grid: { color: "rgba(255,255,255,.06)" } },
        y: { suggestedMin: 0, suggestedMax: 100, ticks: { color: "rgba(255,255,255,.80)" }, grid: { color: "rgba(255,255,255,.06)" } }
      }
    }
  });
}

/* =========================
   NEW ACTIVITY DIALOG
========================= */
function fillOwnersSelect(sel){
  sel.innerHTML = "";
  for(const p of TEAM){
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    sel.appendChild(opt);
  }
}
function addActivity(payload){
  data.activities.push({
    id: uid(),
    owner: payload.owner,
    title: payload.title.trim().slice(0,200),
    week_start: payload.week_start,
    progress: clampInt(payload.progress,0,100,0),
    priority: payload.priority || "normal",
    notes: (payload.notes || "").slice(0,500),
    start_date: safeDateISO(payload.start_date || ""),
    due_date: safeDateISO(payload.due_date || "")
  });
  saveData();
}

$("btnEnableNewDates").addEventListener("click", () => {
  if(!promptCode()){
    alert("Código incorrecto.");
    return;
  }
  $("newDatesBox").style.display = "grid";
});

$("btnAddAct").addEventListener("click", () => {
  fillOwnersSelect($("newOwner"));
  $("newOwner").value = selectedPerson || (TEAM[0] || "");
  $("newWeek").value = getWeek();
  $("newTitle").value = "";
  $("newProgress").value = 0;
  $("newPriority").value = "normal";
  $("newNotes").value = "";
  $("newStartDate").value = "";
  $("newDueDate").value = "";
  $("newDatesBox").style.display = "none";
  $("dlgAct").showModal();
});

$("btnCreateAct").addEventListener("click", (e) => {
  e.preventDefault();
  const payload = {
    owner: $("newOwner").value,
    week_start: $("newWeek").value,
    title: $("newTitle").value,
    progress: $("newProgress").value,
    priority: $("newPriority").value,
    notes: $("newNotes").value,
    start_date: $("newStartDate").value,
    due_date: $("newDueDate").value
  };
  if(!payload.week_start){ alert("Selecciona semana."); return; }
  if(!payload.owner){ alert("Selecciona persona."); return; }
  if(!payload.title.trim()){ alert("Pon un nombre a la actividad."); return; }

  addActivity(payload);
  $("dlgAct").close();

  selectedPerson = payload.owner;
  viewMode = "person";
  renderAll();
});

/* =========================
   TEAM EDITOR
========================= */
function openTeamDialog(focusName=null){
  renderTeamEditor(focusName);
  $("dlgTeam").showModal();
}
function renderTeamEditor(focusName){
  const box = $("teamList");
  box.innerHTML = "";

  TEAM.forEach((name, idx) => {
    const row = document.createElement("div");
    row.className = "teamRow";

    const inp = document.createElement("input");
    inp.type = "text";
    inp.value = name;
    inp.maxLength = 40;

    const del = document.createElement("button");
    del.type = "button";
    del.className = "btn danger";
    del.textContent = "Eliminar";
    del.addEventListener("click", () => {
      if(!confirm(`¿Eliminar a "${name}"? Esto borrará sus actividades.`)) return;
      data.activities = data.activities.filter(a => a.owner !== name);
      TEAM = TEAM.filter((_, i) => i !== idx);
      saveData(); saveTeam();
      if(selectedPerson === name) selectedPerson = TEAM[0] || "";
      renderTeamEditor();
      renderAll();
    });

    row.appendChild(inp);
    row.appendChild(del);
    box.appendChild(row);

    if(focusName && name === focusName){
      setTimeout(() => inp.focus(), 80);
    }
  });
}
$("btnTeam").addEventListener("click", () => openTeamDialog());

$("btnAddPerson").addEventListener("click", () => {
  const v = ($("addPersonName").value || "").trim();
  if(!v) return alert("Escribe un nombre.");
  if(TEAM.some(x => x.toLowerCase() === v.toLowerCase())) return alert("Ese nombre ya existe.");
  TEAM.push(v);
  $("addPersonName").value = "";
  saveTeam();
  renderTeamEditor(v);
  renderAll();
});

$("btnSaveTeam").addEventListener("click", (e) => {
  e.preventDefault();

  const inputs = Array.from($("teamList").querySelectorAll("input"));
  const newNames = inputs.map(i => (i.value || "").trim()).filter(Boolean);

  const lower = newNames.map(n => n.toLowerCase());
  const dup = lower.some((v,i)=> lower.indexOf(v) !== i);
  if(dup) return alert("Hay nombres repetidos. Corrige y guarda.");

  const oldTeam = TEAM.slice();
  const map = new Map();
  for(let i=0;i<oldTeam.length;i++){
    map.set(oldTeam[i], newNames[i] || oldTeam[i]);
  }
  TEAM = newNames;

  data.activities.forEach(a => {
    if(map.has(a.owner)) a.owner = map.get(a.owner);
  });

  saveTeam(); saveData();

  if(map.has(selectedPerson)) selectedPerson = map.get(selectedPerson);
  if(!TEAM.includes(selectedPerson)) selectedPerson = TEAM[0] || "";

  $("dlgTeam").close();
  renderAll();
});

/* =========================
   WEEK NAV & CLEAR
========================= */
function setWeekWithCarry(newWeek){
  const prevWeek = getWeek();
  carryOverIncomplete(prevWeek, newWeek);
  $("weekPicker").value = newWeek;
  renderAll();
}
$("btnPrevWeek").addEventListener("click", () => setWeekWithCarry(addDays(getWeek(), -7)));
$("btnNextWeek").addEventListener("click", () => setWeekWithCarry(addDays(getWeek(), 7)));

$("btnClearPersonWeek").addEventListener("click", () => {
  const week = getWeek();
  if(!selectedPerson) return alert("Selecciona una persona.");
  if(!confirm(`¿Borrar todas las actividades de ${selectedPerson} en la semana ${week}?`)) return;
  data.activities = data.activities.filter(a => !(a.owner === selectedPerson && a.week_start === week));
  saveData();
  renderAll();
});

/* =========================
   SEARCH
========================= */
$("peopleSearch").addEventListener("input", renderPeople);

/* =========================
   RESUMEN OVERLAY
========================= */
function openResumen(){
  viewMode = "summary";
  $("summaryWeekText").textContent = `Semana: ${getWeek()}`;
  const body = $("summaryBody");
  body.innerHTML = "";
  body.appendChild(buildWeeklyStatsBlock(true));
  $("summaryOverlay").classList.add("show");
  $("summaryOverlay").setAttribute("aria-hidden","false");
  renderSelectedDetail();
}
function closeResumen(){
  $("summaryOverlay").classList.remove("show");
  $("summaryOverlay").setAttribute("aria-hidden","true");
  viewMode = selectedPerson ? "person" : "summary";
  renderSelectedDetail();
}
$("btnResumen").addEventListener("click", openResumen);
$("btnCloseResumen").addEventListener("click", closeResumen);
$("summaryOverlay").addEventListener("click", (e) => {
  if(e.target === $("summaryOverlay")) closeResumen();
});
document.addEventListener("keydown", (e) => {
  if(e.key === "Escape" && $("summaryOverlay").classList.contains("show")) closeResumen();
});

/* =========================
   EXPORT EXCEL (ALL ACTIVITIES)
========================= */
function exportExcel(){
  const downloadAt = nowLocalISO();
  const rows = data.activities
    .slice()
    .sort((a,b)=>{
      if(a.owner !== b.owner) return a.owner.localeCompare(b.owner);
      if(a.week_start !== b.week_start) return a.week_start.localeCompare(b.week_start);
      const pa = PRIORITY_ORDER[a.priority || "normal"] || 1;
      const pb = PRIORITY_ORDER[b.priority || "normal"] || 1;
      if(pb !== pa) return pb - pa;
      return String(a.id).localeCompare(String(b.id));
    })
    .map(a => ({
      "Nombre": a.owner,
      "Semana": a.week_start,
      "Actividad": a.title,
      "% Avance": clampInt(a.progress,0,100,0),
      "Carga de proceso": 100 - clampInt(a.progress,0,100,0),
      "Prioridad": prioLabel(a.priority),
      "Fecha ingreso": a.start_date || "",
      "Fecha límite": a.due_date || "",
      "Notas": a.notes || "",
      "Arrastre desde": a.carried_from_week || "",
      "Fecha descarga": downloadAt
    }));

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows.length ? rows : [{
    "Nombre":"", "Semana":"", "Actividad":"", "% Avance":"", "Carga de proceso":"",
    "Prioridad":"", "Fecha ingreso":"", "Fecha límite":"", "Notas":"", "Arrastre desde":"", "Fecha descarga": downloadAt
  }]);

  ws["!cols"] = [
    { wch: 18 }, { wch: 12 }, { wch: 46 }, { wch: 10 },
    { wch: 16 }, { wch: 12 }, { wch: 14 }, { wch: 14 }, { wch: 40 }, { wch: 14 }, { wch: 20 }
  ];

  XLSX.utils.book_append_sheet(wb, ws, "Actividades");
  const fname = `CRM_PREVENCION_${downloadAt.replace(/[: ]/g,"-")}.xlsx`;
  XLSX.writeFile(wb, fname);
}
$("btnExportExcel").addEventListener("click", exportExcel);

/* =========================
   RENDER ALL
========================= */
function renderAll(){
  if(selectedPerson && !TEAM.includes(selectedPerson)) selectedPerson = TEAM[0] || "";
  if(!selectedPerson && TEAM.length) selectedPerson = TEAM[0];
  if(!selectedPerson) viewMode = "summary";

  renderPeople();
  renderSelectedDetail();

  // refresh overlay if open
  if($("summaryOverlay").classList.contains("show")){
    $("summaryWeekText").textContent = `Semana: ${getWeek()}`;
    const body = $("summaryBody");
    body.innerHTML = "";
    body.appendChild(buildWeeklyStatsBlock(true));
  }
}

/* =========================
   INIT
========================= */
(function init(){
  $("weekPicker").value = mondayOf();

  if(!data.activities.length){
    const w = $("weekPicker").value;
    const p0 = TEAM[0] || "Persona 1";
    const p1 = TEAM[1] || p0;

    data.activities.push(
      { id: uid(), owner: p0, title:"Inspección semanal", week_start:w, progress:25, priority:"alto", notes:"Edita o borra esta actividad.", start_date:"", due_date:"" },
      { id: uid(), owner: p0, title:"Informe preventivo", week_start:w, progress:60, priority:"medio", notes:"Fechas se editan con código 0800.", start_date:"", due_date:"" },
      { id: uid(), owner: p1, title:"Seguimiento de hallazgos", week_start:w, progress:10, priority:"urgente", notes:"Arrastre automático si no llega a 100%.", start_date:"", due_date:"" }
    );
    saveData();
  }

  $("weekPicker").addEventListener("change", () => {
    const newW = $("weekPicker").value;
    const prevW = $("weekPicker").dataset.prevWeek || newW;
    carryOverIncomplete(prevW, newW);
    $("weekPicker").dataset.prevWeek = newW;
    renderAll();
  });

  $("weekPicker").dataset.prevWeek = $("weekPicker").value;

  selectedPerson = TEAM[0] || "";
  renderAll();

  // Live countdown refresh each minute (only affects visible cards)
  setInterval(() => {
    // just rerender detail if in person view to update countdown text
    if(viewMode === "person") renderSelectedDetail();
  }, 60000);
})();
</script>
</body>
</html>
