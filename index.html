<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CRM PREVENCIÓN</title>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Excel export (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#07070a;
      --panel:#0d0e12;
      --card:#11121a;
      --card2:#0f1016;
      --text:#ffffff;
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.55);
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.14);
      --red:#ff2a2a;
      --red2:#b80000;
      --white:#ffffff;
      --black:#000000;
      --soft:rgba(255,255,255,.04);
      --soft2:rgba(255,255,255,.06);
      --good:#2dd4bf;
      --warn:#fbbf24;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 12% 0%, rgba(255,42,42,.20), transparent 60%),
        radial-gradient(900px 500px at 88% 10%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(180deg, #050509 0%, #090914 100%);
    }

    /* Header */
    header{
      position:sticky; top:0; z-index:20;
      background: linear-gradient(180deg, rgba(0,0,0,.92) 0%, rgba(0,0,0,.70) 100%);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:16px 18px 12px 18px; flex-wrap:wrap;
    }
    .brand{display:flex; gap:12px; align-items:center}
    .mark{
      width:14px;height:14px;border-radius:999px;
      background: linear-gradient(135deg, var(--red), rgba(255,255,255,.70));
      box-shadow: 0 0 22px rgba(255,42,42,.55);
    }
    h1{margin:0; font-size:18px; letter-spacing:.22em; text-transform:uppercase}
    .sub{margin:2px 0 0 0; color:var(--muted); font-size:12px}

    .controls{
      display:flex; gap:10px; align-items:end; flex-wrap:wrap; justify-content:flex-end;
    }
    label{font-size:12px; color:var(--muted); display:grid; gap:6px}
    input, select, textarea, button{font:inherit}
    input, select, textarea{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 12px;
      outline: none;
    }
    textarea{min-height:56px; resize:vertical}

    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
    }
    .btn:hover{
      border-color: rgba(255,255,255,.25);
      background: rgba(255,255,255,.06);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(255,42,42,.28), rgba(255,255,255,.06));
      border-color: rgba(255,42,42,.45);
    }
    .btn.ghost{
      background: rgba(255,255,255,.02);
      border-color: rgba(255,255,255,.10);
    }
    .btn.danger{
      background: rgba(255,42,42,.10);
      border-color: rgba(255,42,42,.35);
      color: #ffd1d1;
    }
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      background: rgba(255,255,255,.02);
    }

    /* Layout */
    main{
      padding: 14px 18px 18px 18px;
      display:grid;
      gap:14px;
    }

    .shell{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      align-items:start;
    }

    .card{
      background: rgba(14,15,20,.86);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 20px;
      padding: 14px;
      box-shadow: 0 22px 90px rgba(0,0,0,.50);
    }

    .cardTitle{
      display:flex; justify-content:space-between; align-items:baseline; gap:10px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .cardTitle h2{
      margin:0;
      font-size: 13px;
      letter-spacing: .12em;
      text-transform: uppercase;
    }
    .hint{ color: var(--muted); font-size: 12px; }

    /* People list */
    .peopleTop{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin-bottom: 10px;
    }
    .search{
      width: 100%;
    }

    .peopleList{
      display:grid;
      gap:10px;
      margin-top: 10px;
    }

    .personTile{
      display:grid;
      grid-template-columns: 68px 1fr;
      gap:10px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      cursor: pointer;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
    }
    .personTile:hover{
      border-color: rgba(255,255,255,.20);
      background: rgba(255,255,255,.04);
      transform: translateY(-1px);
    }
    .personTile.active{
      border-color: rgba(255,42,42,.50);
      box-shadow: 0 0 0 2px rgba(255,42,42,.16) inset;
    }
    .miniChartWrap{
      width: 68px; height: 68px;
      border-radius: 18px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:center;
    }
    .miniChart{
      width: 52px !important; height: 52px !important;
    }
    .personInfo{display:flex; flex-direction:column; gap:6px;}
    .personNameRow{display:flex; gap:8px; align-items:center; justify-content:space-between}
    .personName{
      font-weight: 750;
      letter-spacing: .05em;
      text-transform: uppercase;
      font-size: 12px;
      line-height: 1.2;
      max-width: 210px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .editBtn{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      border-radius: 10px;
      padding: 6px 8px;
      cursor:pointer;
    }
    .editBtn:hover{ border-color: rgba(255,255,255,.20); color: var(--white); }
    .personMeta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      color: var(--muted2);
      font-size: 12px;
    }
    .tag{
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }

    /* Detail panel */
    .detailHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .detailTitle{
      display:flex; flex-direction:column; gap:4px;
    }
    .detailTitle .big{
      font-size: 16px;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .detailTitle .small{
      color: var(--muted);
      font-size: 12px;
    }
    .detailActions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

    /* Activity list (only selected person) */
    .activityList{ display:grid; gap:10px; }

    .activityCard{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      padding: 12px;
      display:grid;
      gap:10px;
    }

    .row1{
      display:grid;
      grid-template-columns: 1fr 260px;
      gap: 10px;
      align-items:start;
    }

    .actTitle{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .actTitle input{
      width: 100%;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
    }

    .rightBox{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      padding: 10px;
      display:grid;
      gap:10px;
    }

    .progressLine{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      color: var(--muted);
      font-size: 12px;
    }
    .slider{
      width: 100%;
      accent-color: var(--red);
    }

    .row2{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap: 10px;
      align-items:start;
    }

    .stars{ display:inline-flex; gap:4px; user-select:none; }
    .star{ cursor:pointer; font-size:16px; opacity:.30; }
    .star.on{ opacity:1; color: var(--white); text-shadow: 0 0 12px rgba(255,42,42,.25); }

    .notesBox textarea{
      width: 100%;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
    }

    .actFooter{
      display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap;
      color: var(--muted2);
      font-size: 12px;
    }

    /* Weekly stats */
    .weeklyGrid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:14px;
      align-items:start;
    }
    .box{
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      padding: 12px;
    }
    .barWrap{
      border-radius: 18px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.08);
      padding: 10px;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      min-width: 860px;
    }
    th, td{
      border-bottom: 1px solid rgba(255,255,255,.10);
      padding: 10px;
      vertical-align: top;
    }
    th{
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 12px;
      background: rgba(255,255,255,.02);
    }

    .cyl{
      height: 14px;
      width: 220px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      box-shadow: inset 0 2px 6px rgba(0,0,0,.40);
    }
    .cyl > div{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,42,42,.95), rgba(184,0,0,.95));
      box-shadow: inset 0 2px 10px rgba(255,255,255,.18);
    }
    .nowrap{ white-space:nowrap; }

    /* Dialog */
    dialog{
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      background: rgba(10,10,14,.96);
      color: var(--text);
      padding: 0;
      max-width: 620px;
      width: calc(100% - 24px);
      box-shadow: 0 30px 140px rgba(0,0,0,.65);
    }
    .dlgForm{ padding: 14px; display:grid; gap:10px; }
    .dlgActions{ display:flex; gap:10px; justify-content:flex-end; padding-top:4px; }
    .two{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .teamList{
      display:grid; gap:8px;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      max-height: 280px;
      overflow:auto;
    }
    .teamRow{
      display:grid;
      grid-template-columns: 1fr 90px;
      gap:10px;
      align-items:center;
    }
    .teamRow input{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
    }

    footer{
      padding: 12px 18px 18px 18px;
      color: rgba(255,255,255,.65);
      font-size: 12px;
      text-align:center;
      letter-spacing: .06em;
    }
    footer b{ color: rgba(255,255,255,.90); }

    @media (max-width: 1050px){
      .shell{ grid-template-columns: 1fr; }
      .weeklyGrid{ grid-template-columns: 1fr; }
      .row1{ grid-template-columns: 1fr; }
      table{ min-width: 0; }
      .cyl{ width: 180px; }
    }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="mark"></div>
      <div>
        <h1>CRM PREVENCIÓN</h1>
        <div class="sub">Selecciona una persona → gestiona sus actividades semanales → exporta Excel</div>
      </div>
    </div>

    <div class="controls">
      <label>
        Semana que inicia (lunes)
        <input id="weekPicker" type="date">
      </label>
      <button class="btn ghost" id="btnTeam">Editar equipo</button>
      <button class="btn primary" id="btnAddAct">+ Nueva actividad</button>
      <button class="btn" id="btnExportExcel">Exportar Excel</button>
      <span class="pill">Guardado automático (este navegador)</span>
    </div>
  </div>
</header>

<main>
  <div class="shell">
    <!-- LEFT: PEOPLE -->
    <section class="card">
      <div class="cardTitle">
        <h2>Equipo</h2>
        <div class="hint">Click en un nombre para ver solo sus actividades.</div>
      </div>

      <input id="peopleSearch" class="search" type="text" placeholder="Buscar persona..." />

      <div class="peopleList" id="peopleList"></div>
    </section>

    <!-- RIGHT: DETAIL -->
    <section class="card">
      <div class="detailHead">
        <div class="detailTitle">
          <div class="big" id="selPersonName">Selecciona una persona</div>
          <div class="small" id="selPersonMeta">Semana: —</div>
        </div>

        <div class="detailActions">
          <button class="btn" id="btnPrevWeek">◀ Semana</button>
          <button class="btn" id="btnNextWeek">Semana ▶</button>
          <button class="btn danger" id="btnClearPersonWeek" title="Borra actividades de ESTA semana solo para esta persona">Borrar semana (persona)</button>
        </div>
      </div>

      <div class="activityList" id="activityList"></div>
    </section>
  </div>

  <!-- WEEKLY STATISTICS -->
  <section class="card">
    <div class="cardTitle">
      <h2>Estadística semanal</h2>
      <div class="hint">Todas las actividades de la semana, con % y cilindros de avance.</div>
    </div>

    <div class="weeklyGrid">
      <div class="box">
        <div class="hint" style="margin-bottom:10px">
          Barras por persona (promedio de avance en la semana).
        </div>
        <div class="barWrap">
          <canvas id="weekBar" height="240"></canvas>
        </div>
      </div>

      <div class="box" style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Persona</th>
              <th>Actividad</th>
              <th class="nowrap">% Avance</th>
              <th class="nowrap">Carga</th>
              <th>Progreso</th>
              <th class="nowrap">⭐</th>
            </tr>
          </thead>
          <tbody id="weekTableBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<footer>
  CREADO BY <b>Humber codes</b> — derechos reservados
</footer>

<!-- DIALOG: NEW ACTIVITY -->
<dialog id="dlgAct">
  <form method="dialog" class="dlgForm">
    <h3 style="margin:0; letter-spacing:.12em; text-transform:uppercase">Nueva actividad</h3>

    <div class="two">
      <label>Persona
        <select id="newOwner"></select>
      </label>
      <label>Semana (lunes)
        <input id="newWeek" type="date" required>
      </label>
    </div>

    <label>Actividad
      <input id="newTitle" maxlength="200" placeholder="Ej: Inspección, informe, seguimiento..." required />
    </label>

    <div class="two">
      <label>% Avance
        <input id="newProgress" type="number" min="0" max="100" value="0" />
      </label>
      <label>Prioridad (1-5)
        <input id="newPriority" type="number" min="1" max="5" value="3" />
      </label>
    </div>

    <label>Notas
      <textarea id="newNotes" maxlength="500" placeholder="Opcional"></textarea>
    </label>

    <div class="dlgActions">
      <button class="btn">Cancelar</button>
      <button id="btnCreateAct" class="btn primary" value="ok">Crear</button>
    </div>
  </form>
</dialog>

<!-- DIALOG: EDIT TEAM -->
<dialog id="dlgTeam">
  <form method="dialog" class="dlgForm">
    <h3 style="margin:0; letter-spacing:.12em; text-transform:uppercase">Editar equipo</h3>

    <div class="hint">
      Cambia nombres, agrega o elimina personas. (Los datos de actividades se mantienen; si borras una persona, sus actividades también se borran).
    </div>

    <div class="teamList" id="teamList"></div>

    <div class="two">
      <label>Nueva persona
        <input id="addPersonName" maxlength="40" placeholder="Ej: Juan Pérez" />
      </label>
      <div style="display:grid; align-content:end">
        <button class="btn primary" id="btnAddPerson" type="button">+ Agregar</button>
      </div>
    </div>

    <div class="dlgActions">
      <button class="btn">Cerrar</button>
      <button class="btn ghost" id="btnSaveTeam" value="ok">Guardar</button>
    </div>
  </form>
</dialog>

<script>
/* =========================
   NOTE: "3D" pies
   Chart.js no tiene 3D real.
   Aquí lo simulamos con sombra y anillo (doughnut) para que se vea más moderno.
========================= */

/* =========================
   STORAGE KEYS
========================= */
const LS_KEY_DATA = "crm_prevencion_data_v3";
const LS_KEY_TEAM = "crm_prevencion_team_v3";

/* =========================
   HELPERS
========================= */
const $ = (id) => document.getElementById(id);

function clampInt(n, min, max, fallback=min){
  const x = parseInt(n, 10);
  if (Number.isNaN(x)) return fallback;
  return Math.max(min, Math.min(max, x));
}
function mondayOf(date=new Date()){
  const d = new Date(date);
  const day = d.getDay(); // 0 domingo
  const diff = (day === 0 ? -6 : 1) - day;
  d.setDate(d.getDate() + diff);
  d.setHours(0,0,0,0);
  return d.toISOString().slice(0,10);
}
function addDays(isoDate, days){
  const d = new Date(isoDate + "T00:00:00");
  d.setDate(d.getDate() + days);
  return d.toISOString().slice(0,10);
}
function uid(){
  return Math.random().toString(36).slice(2,9) + "-" + Date.now().toString(36);
}
function nowLocalISO(){
  const d = new Date();
  const pad = (n) => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

/* =========================
   STATE
========================= */
let TEAM = loadTeam() || ["Persona 1","Persona 2","Persona 3","Persona 4","Persona 5","Persona 6","Persona 7"];
let data = loadData() || { activities: [] };

let selectedPerson = TEAM[0] || "";
let chartsMini = {}; // person -> Chart
let chartWeekBar = null;

/* =========================
   LOAD/SAVE
========================= */
function saveData(){
  localStorage.setItem(LS_KEY_DATA, JSON.stringify(data));
}
function loadData(){
  try{
    const raw = localStorage.getItem(LS_KEY_DATA);
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}
function saveTeam(){
  localStorage.setItem(LS_KEY_TEAM, JSON.stringify(TEAM));
}
function loadTeam(){
  try{
    const raw = localStorage.getItem(LS_KEY_TEAM);
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}

/* =========================
   GET WEEK & FILTERS
========================= */
function getWeek(){ return $("weekPicker").value; }
function weekActivities(week){ return data.activities.filter(a => a.week_start === week); }
function personWeekActivities(person, week){
  return data.activities.filter(a => a.owner === person && a.week_start === week);
}
function sortByPriority(rows){
  return rows.slice().sort((a,b)=>{
    if (b.priority !== a.priority) return b.priority - a.priority;
    return String(b.id).localeCompare(String(a.id));
  });
}

/* =========================
   STARS UI
========================= */
function renderStars(value, onChange){
  const wrap = document.createElement("div");
  wrap.className = "stars";
  for(let i=1;i<=5;i++){
    const s = document.createElement("span");
    s.className = "star" + (i<=value ? " on" : "");
    s.textContent = "★";
    s.title = `Prioridad ${i}`;
    s.addEventListener("click", () => onChange(i));
    wrap.appendChild(s);
  }
  return wrap;
}

/* =========================
   CHART PLUGIN: SHADOW (fake 3D)
========================= */
const shadowPlugin = {
  id: "shadowPlugin",
  beforeDatasetsDraw(chart, args, pluginOptions) {
    const { ctx } = chart;
    ctx.save();
    ctx.shadowColor = "rgba(0,0,0,.55)";
    ctx.shadowBlur = 16;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 6;
  },
  afterDatasetsDraw(chart) {
    chart.ctx.restore();
  }
};

/* =========================
   RENDER: PEOPLE LIST
========================= */
function renderPeople(){
  const q = ($("peopleSearch").value || "").trim().toLowerCase();
  const list = $("peopleList");
  list.innerHTML = "";

  const week = getWeek();

  for(const person of TEAM){
    if(q && !person.toLowerCase().includes(q)) continue;

    const rows = personWeekActivities(person, week);
    const tasks = rows.length;
    const avg = tasks ? Math.round(rows.reduce((s,a)=>s+clampInt(a.progress,0,100,0),0)/tasks) : 0;
    const remaining = tasks ? rows.reduce((s,a)=>s+(100-clampInt(a.progress,0,100,0)),0) : 0;

    const tile = document.createElement("div");
    tile.className = "personTile" + (person === selectedPerson ? " active" : "");
    tile.addEventListener("click", () => {
      selectedPerson = person;
      renderAll();
    });

    const chartWrap = document.createElement("div");
    chartWrap.className = "miniChartWrap";
    const canvas = document.createElement("canvas");
    canvas.className = "miniChart";
    chartWrap.appendChild(canvas);

    const info = document.createElement("div");
    info.className = "personInfo";

    const nameRow = document.createElement("div");
    nameRow.className = "personNameRow";

    const name = document.createElement("div");
    name.className = "personName";
    name.textContent = person;

    const edit = document.createElement("button");
    edit.className = "editBtn";
    edit.type = "button";
    edit.textContent = "✎";
    edit.title = "Editar nombre";
    edit.addEventListener("click", (ev) => {
      ev.stopPropagation();
      openTeamDialog(person);
    });

    nameRow.appendChild(name);
    nameRow.appendChild(edit);

    const meta = document.createElement("div");
    meta.className = "personMeta";
    meta.innerHTML = `
      <span class="tag">${tasks} act.</span>
      <span class="tag">avg ${avg}%</span>
      <span class="tag">carga ${remaining}</span>
    `;

    info.appendChild(nameRow);
    info.appendChild(meta);

    tile.appendChild(chartWrap);
    tile.appendChild(info);
    list.appendChild(tile);

    // Mini chart (small "3D" doughnut)
    // Distribution: Avance vs Pendiente
    const done = avg;
    const pend = 100 - avg;

    // destroy old if exists
    if(chartsMini[person]) { try{ chartsMini[person].destroy(); }catch(e){} }

    chartsMini[person] = new Chart(canvas, {
      type: "doughnut",
      plugins: [shadowPlugin],
      data: {
        labels: ["Avance", "Pendiente"],
        datasets: [{
          data: tasks ? [done, pend] : [0, 100],
          backgroundColor: [
            "rgba(255,42,42,.92)",
            "rgba(255,255,255,.10)"
          ],
          borderColor: "rgba(255,255,255,.12)",
          borderWidth: 1,
          hoverOffset: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: "70%",
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        }
      }
    });
  }
}

/* =========================
   RENDER: PERSON DETAIL (ONLY SELECTED)
========================= */
function renderSelectedDetail(){
  const week = getWeek();

  $("selPersonName").textContent = selectedPerson ? selectedPerson : "Selecciona una persona";
  $("selPersonMeta").textContent = `Semana: ${week}`;

  const list = $("activityList");
  list.innerHTML = "";

  if(!selectedPerson){
    list.innerHTML = `<span class="pill">No hay persona seleccionada.</span>`;
    return;
  }

  const rows = sortByPriority(personWeekActivities(selectedPerson, week));

  if(!rows.length){
    list.innerHTML = `<span class="pill">Sin actividades para ${selectedPerson} en esta semana. Usa “+ Nueva actividad”.</span>`;
    return;
  }

  for(const a of rows){
    const card = document.createElement("div");
    card.className = "activityCard";

    const row1 = document.createElement("div");
    row1.className = "row1";

    // Left: title
    const left = document.createElement("div");
    left.className = "actTitle";
    const title = document.createElement("input");
    title.type = "text";
    title.maxLength = 200;
    title.value = a.title;
    title.addEventListener("change", () => {
      a.title = title.value.trim().slice(0,200);
      saveData(); renderWeeklyStats(); // refresh weekly table labels
    });
    left.appendChild(title);

    // Right: progress box
    const right = document.createElement("div");
    right.className = "rightBox";

    const progLine = document.createElement("div");
    progLine.className = "progressLine";
    const v = clampInt(a.progress,0,100,0);
    progLine.innerHTML = `<span>% Avance</span><b>${v}%</b>`;
    const slider = document.createElement("input");
    slider.className = "slider";
    slider.type = "range";
    slider.min = 0;
    slider.max = 100;
    slider.value = v;
    slider.addEventListener("input", () => {
      const nv = clampInt(slider.value,0,100,0);
      progLine.innerHTML = `<span>% Avance</span><b>${nv}%</b>`;
    });
    slider.addEventListener("change", () => {
      a.progress = clampInt(slider.value,0,100,0);
      saveData();
      renderPeople(); // update mini charts
      renderWeeklyStats();
    });

    const carga = document.createElement("div");
    carga.className = "progressLine";
    carga.innerHTML = `<span>Carga de proceso</span><b>${100 - v}</b>`;

    right.appendChild(progLine);
    right.appendChild(slider);
    right.appendChild(carga);

    row1.appendChild(left);
    row1.appendChild(right);

    // Row2: priority + notes
    const row2 = document.createElement("div");
    row2.className = "row2";

    const priBox = document.createElement("div");
    priBox.className = "rightBox";
    const priTitle = document.createElement("div");
    priTitle.className = "progressLine";
    priTitle.innerHTML = `<span>Prioridad</span><b>${clampInt(a.priority,1,5,3)}</b>`;
    priBox.appendChild(priTitle);
    priBox.appendChild(renderStars(clampInt(a.priority,1,5,3), (nv) => {
      a.priority = nv;
      saveData();
      renderSelectedDetail(); // re-order
      renderWeeklyStats();
    }));

    const notes = document.createElement("div");
    notes.className = "notesBox";
    const ta = document.createElement("textarea");
    ta.maxLength = 500;
    ta.placeholder = "Notas (opcional)";
    ta.value = a.notes || "";
    ta.addEventListener("change", () => {
      a.notes = ta.value.slice(0,500);
      saveData();
    });
    notes.appendChild(ta);

    row2.appendChild(priBox);
    row2.appendChild(notes);

    // Footer actions
    const foot = document.createElement("div");
    foot.className = "actFooter";
    foot.innerHTML = `<span>ID: ${a.id}</span><span>carga: <b>${100 - clampInt(a.progress,0,100,0)}</b></span>`;

    const del = document.createElement("button");
    del.className = "btn danger";
    del.type = "button";
    del.textContent = "Borrar";
    del.addEventListener("click", () => {
      if(!confirm("¿Borrar esta actividad?")) return;
      data.activities = data.activities.filter(x => x.id !== a.id);
      saveData();
      renderAll();
    });

    foot.appendChild(del);

    card.appendChild(row1);
    card.appendChild(row2);
    card.appendChild(foot);
    list.appendChild(card);
  }
}

/* =========================
   WEEKLY STATISTICS
========================= */
function renderWeeklyStats(){
  const week = getWeek();
  const rows = weekActivities(week);

  // Table
  const tb = $("weekTableBody");
  tb.innerHTML = "";

  const sorted = rows.slice().sort((a,b)=>{
    if(a.owner !== b.owner) return a.owner.localeCompare(b.owner);
    if(b.priority !== a.priority) return b.priority - a.priority;
    return (b.progress - a.progress);
  });

  if(!sorted.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="6"><span class="pill">No hay actividades en esta semana.</span></td>`;
    tb.appendChild(tr);
  }else{
    for(const a of sorted){
      const av = clampInt(a.progress,0,100,0);
      const carga = 100 - av;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="nowrap">${a.owner}</td>
        <td>${(a.title||"").slice(0,140)}</td>
        <td class="nowrap"><b>${av}%</b></td>
        <td class="nowrap">${carga}</td>
        <td>
          <div class="cyl"><div style="width:${av}%"></div></div>
        </td>
        <td class="nowrap">${"★".repeat(clampInt(a.priority,1,5,3))}</td>
      `;
      tb.appendChild(tr);
    }
  }

  // Bar chart (avg progress by person)
  const labels = TEAM.slice();
  const avgs = labels.map(p => {
    const pr = personWeekActivities(p, week);
    if(!pr.length) return 0;
    return Math.round(pr.reduce((s,a)=>s+clampInt(a.progress,0,100,0),0)/pr.length);
  });

  // destroy & rebuild
  if(chartWeekBar){ try{ chartWeekBar.destroy(); }catch(e){} }

  const ctx = $("weekBar");

  chartWeekBar = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Avance promedio (%)",
        data: avgs,
        backgroundColor: "rgba(255,42,42,.80)",
        borderColor: "rgba(255,255,255,.18)",
        borderWidth: 1,
        borderRadius: 999, // makes it look like cylinders
        barThickness: 18
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: { label: (c) => ` ${c.raw}%` }
        }
      },
      scales: {
        x: {
          ticks: { color: "rgba(255,255,255,.80)" },
          grid: { color: "rgba(255,255,255,.06)" }
        },
        y: {
          suggestedMin: 0,
          suggestedMax: 100,
          ticks: { color: "rgba(255,255,255,.80)" },
          grid: { color: "rgba(255,255,255,.06)" }
        }
      }
    }
  });
}

/* =========================
   NEW ACTIVITY DIALOG
========================= */
function fillOwnersSelect(sel){
  sel.innerHTML = "";
  for(const p of TEAM){
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    sel.appendChild(opt);
  }
}
function addActivity(payload){
  data.activities.push({
    id: uid(),
    owner: payload.owner,
    title: payload.title.trim().slice(0,200),
    week_start: payload.week_start,
    progress: clampInt(payload.progress,0,100,0),
    priority: clampInt(payload.priority,1,5,3),
    notes: (payload.notes || "").slice(0,500)
  });
  saveData();
}

$("btnAddAct").addEventListener("click", () => {
  fillOwnersSelect($("newOwner"));
  $("newOwner").value = selectedPerson || (TEAM[0] || "");
  $("newWeek").value = getWeek();
  $("newTitle").value = "";
  $("newProgress").value = 0;
  $("newPriority").value = 3;
  $("newNotes").value = "";
  $("dlgAct").showModal();
});

$("btnCreateAct").addEventListener("click", (e) => {
  e.preventDefault();
  const payload = {
    owner: $("newOwner").value,
    week_start: $("newWeek").value,
    title: $("newTitle").value,
    progress: $("newProgress").value,
    priority: $("newPriority").value,
    notes: $("newNotes").value
  };
  if(!payload.week_start){ alert("Selecciona semana."); return; }
  if(!payload.owner){ alert("Selecciona persona."); return; }
  if(!payload.title.trim()){ alert("Pon un nombre a la actividad."); return; }

  addActivity(payload);
  $("dlgAct").close();

  selectedPerson = payload.owner;
  renderAll();
});

/* =========================
   TEAM EDITOR
========================= */
function openTeamDialog(focusName=null){
  renderTeamEditor(focusName);
  $("dlgTeam").showModal();
}
function renderTeamEditor(focusName){
  const box = $("teamList");
  box.innerHTML = "";

  TEAM.forEach((name, idx) => {
    const row = document.createElement("div");
    row.className = "teamRow";

    const inp = document.createElement("input");
    inp.type = "text";
    inp.value = name;
    inp.maxLength = 40;

    const del = document.createElement("button");
    del.type = "button";
    del.className = "btn danger";
    del.textContent = "Eliminar";
    del.addEventListener("click", () => {
      if(!confirm(`¿Eliminar a "${name}"? Esto borrará sus actividades.`)) return;

      // Remove activities
      data.activities = data.activities.filter(a => a.owner !== name);
      // Remove from team
      TEAM = TEAM.filter((_, i) => i !== idx);

      saveData();
      saveTeam();

      // fix selected
      if(selectedPerson === name) selectedPerson = TEAM[0] || "";
      renderTeamEditor();
      renderAll();
    });

    row.appendChild(inp);
    row.appendChild(del);

    box.appendChild(row);

    if(focusName && name === focusName){
      setTimeout(() => inp.focus(), 80);
    }
  });
}
$("btnTeam").addEventListener("click", () => openTeamDialog());

$("btnAddPerson").addEventListener("click", () => {
  const v = ($("addPersonName").value || "").trim();
  if(!v) return alert("Escribe un nombre.");
  if(TEAM.some(x => x.toLowerCase() === v.toLowerCase())) return alert("Ese nombre ya existe.");
  TEAM.push(v);
  $("addPersonName").value = "";
  saveTeam();
  renderTeamEditor(v);
  renderAll();
});

$("btnSaveTeam").addEventListener("click", (e) => {
  e.preventDefault();

  // Read current inputs in team editor and apply renames
  const inputs = Array.from($("teamList").querySelectorAll("input"));
  const newNames = inputs.map(i => (i.value || "").trim()).filter(Boolean);

  // Validate duplicates
  const lower = newNames.map(n => n.toLowerCase());
  const dup = lower.some((v,i)=> lower.indexOf(v) !== i);
  if(dup) return alert("Hay nombres repetidos. Corrige y guarda.");

  // Map old->new (by index)
  const oldTeam = TEAM.slice();
  const map = new Map();
  for(let i=0;i<oldTeam.length;i++){
    map.set(oldTeam[i], newNames[i] || oldTeam[i]);
  }

  TEAM = newNames;

  // Apply renames in activities
  data.activities.forEach(a => {
    if(map.has(a.owner)) a.owner = map.get(a.owner);
  });

  saveTeam();
  saveData();

  // Fix selected
  if(map.has(selectedPerson)) selectedPerson = map.get(selectedPerson);
  if(!TEAM.includes(selectedPerson)) selectedPerson = TEAM[0] || "";

  $("dlgTeam").close();
  renderAll();
});

/* =========================
   WEEK NAV & CLEAR
========================= */
$("btnPrevWeek").addEventListener("click", () => {
  $("weekPicker").value = addDays(getWeek(), -7);
  renderAll();
});
$("btnNextWeek").addEventListener("click", () => {
  $("weekPicker").value = addDays(getWeek(), 7);
  renderAll();
});

$("btnClearPersonWeek").addEventListener("click", () => {
  const week = getWeek();
  if(!selectedPerson) return alert("Selecciona una persona.");
  if(!confirm(`¿Borrar todas las actividades de ${selectedPerson} en la semana ${week}?`)) return;
  data.activities = data.activities.filter(a => !(a.owner === selectedPerson && a.week_start === week));
  saveData();
  renderAll();
});

/* =========================
   SEARCH
========================= */
$("peopleSearch").addEventListener("input", renderPeople);

/* =========================
   EXPORT EXCEL (ALL ACTIVITIES)
   Columns: Nombre, Semana, Actividad, % Avance, Carga, Prioridad, Notas, Fecha descarga
========================= */
function exportExcel(){
  const downloadAt = nowLocalISO();
  const rows = data.activities
    .slice()
    .sort((a,b)=>{
      if(a.owner !== b.owner) return a.owner.localeCompare(b.owner);
      if(a.week_start !== b.week_start) return a.week_start.localeCompare(b.week_start);
      return String(a.id).localeCompare(String(b.id));
    })
    .map(a => ({
      "Nombre": a.owner,
      "Fecha (Semana)": a.week_start,
      "Actividad": a.title,
      "% Avance": clampInt(a.progress,0,100,0),
      "Carga de proceso": 100 - clampInt(a.progress,0,100,0),
      "Prioridad (1-5)": clampInt(a.priority,1,5,3),
      "Notas": a.notes || "",
      "Fecha descarga": downloadAt
    }));

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows.length ? rows : [{
    "Nombre":"", "Fecha (Semana)":"", "Actividad":"", "% Avance":"", "Carga de proceso":"",
    "Prioridad (1-5)":"", "Notas":"", "Fecha descarga": downloadAt
  }]);

  ws["!cols"] = [
    { wch: 18 }, { wch: 14 }, { wch: 42 }, { wch: 10 },
    { wch: 16 }, { wch: 14 }, { wch: 40 }, { wch: 20 }
  ];

  XLSX.utils.book_append_sheet(wb, ws, "Actividades");
  const fname = `CRM_PREVENCION_${downloadAt.replace(/[: ]/g,"-")}.xlsx`;
  XLSX.writeFile(wb, fname);
}
$("btnExportExcel").addEventListener("click", exportExcel);

/* =========================
   RENDER ALL
========================= */
function renderAll(){
  // Ensure selected person exists
  if(selectedPerson && !TEAM.includes(selectedPerson)) selectedPerson = TEAM[0] || "";
  if(!selectedPerson && TEAM.length) selectedPerson = TEAM[0];

  renderPeople();
  renderSelectedDetail();
  renderWeeklyStats();
}

/* =========================
   INIT
========================= */
(function init(){
  $("weekPicker").value = mondayOf();

  // Seed if empty
  if(!data.activities.length){
    const w = $("weekPicker").value;
    const p0 = TEAM[0] || "Persona 1";
    const p1 = TEAM[1] || p0;

    data.activities.push(
      { id: uid(), owner: p0, title:"Inspección semanal", week_start:w, progress:25, priority:4, notes:"Edita o borra esta actividad." },
      { id: uid(), owner: p0, title:"Informe preventivo", week_start:w, progress:60, priority:3, notes:"La mini gráfica muestra avance vs pendiente." },
      { id: uid(), owner: p1, title:"Seguimiento de hallazgos", week_start:w, progress:10, priority:5, notes:"Prioridad alta (★★★★★)." }
    );
    saveData();
  }

  // Week change
  $("weekPicker").addEventListener("change", renderAll);

  // Default selection
  selectedPerson = TEAM[0] || "";
  renderAll();
})();
</script>
</body>
</html>